sudo: required
services:
- docker
git:
  depth: false
language: node_js
node_js:
- '10'
stages:
- build application
- stable package
- nightly package
jobs:
  include:
  - stage: build application
    name: Test build
    script: yarn build
  - stage: stable package
    if: branch != master OR tag =~ ^.*$
    env: CACHE_NAME=yeti_client_package
    name: Stable package - Stretch + Buster
    script: &1
    - docker build -t yeti-client -f ./ci/build_buster.Dockerfile .
    - docker run --name yeti-client yeti-client && docker commit yeti-client yeti-client:built
    deploy:
      skip_cleanup: true
      provider: script
      script:
      - docker run --name yeti-client-deploy yeti-client:built ci/deploy.sh "$API_ENDPOINT"
        stretch "${TRAVIS_TAG:0:3}" main /build/*.deb
      - docker run --name yeti-client-deploy yeti-client:built ci/deploy.sh "$API_ENDPOINT"
        buster "${TRAVIS_TAG:0:3}" main /build/*.deb
      on:
        tags: true
        condition: "$TRAVIS_TAG != *-master*"
        repo: yeti-switch/yeti-client
  - stage: nightly package
    if: branch = master
    env: CACHE_NAME=yeti_client_package
    name: Nightly package - Stretch + Buster
    script: *1
    deploy:
      skip_cleanup: true
      provider: script
      script:
      - docker run --name yeti-client-deploy yeti-client:built ci/deploy.sh "$API_ENDPOINT"
        stretch nightly main /build/*.deb
      - docker run --name yeti-client-deploy yeti-client:built ci/deploy.sh "$API_ENDPOINT"
        buster nightly main /build/*.deb
      on:
        all_branches: true
        repo: yeti-switch/yeti-client
env:
  global:
    secure: q8zuN8jLovW63+ZkSCGudL31vm6LJEbbIkJzyqqw0KE+EeTVMoeIIZ3J6gb++db3cEuAH0QQvYTivrxLu30PohdgDWg6xEwBoLLFA9DA7nE5kCNK22IaSzdTJZPtgow/fAGpnpOui6ubtQD4vr3mbxYYdiFhR4eXaueU4UOcnEw18jZ1/NTGY0XeWL7Xz2iSuvYhLEFRF/bDIwrFOJ8Jxkv5Bu6qz2RIINfifgWCexeAsHihJrxHIrInksyh36nuDSYa41H37ftKLeOeLZcdiom2r5EPI8jEopiQyOVXMnNBTwLovsSdrIBnZK+P4SI5fIvOipuOJgtGrfuvpSXrvNV3fjrBbdX9n0syf22FPxrji8mZD1la89Z383dNdj7x+1RP9/AsuB15bzSNihzXRcRe4d+cmxwcmOx6ghvnkd3fuKSqZTQXPBcnREtyueuIsBmoYuGXl0CRdHev3vTI5zs98OUobhNS90fitz8EbDT4iag/+h7BgK9X+QIORPGCr20IHU8pvhmU5MD0tejNCHExiqwVs5oVyUBpIrVP0A3gDhhfA24oAoGlSYuFbJCaRP/vO5bD/r6b6vIGphmCCcFLY801ot6hKPX1dFkihQfQa3NtYwhsgMRolYGrzM8ryCfx0BtMP+NzH7iIQvU+wj1W52KBCe6/EvKUNDfb2K0=
